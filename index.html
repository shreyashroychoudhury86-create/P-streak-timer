<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Streak Tracker</title>
  <style>
    :root{
      --bg:#0b0f14;           /* dark background */
      --panel:#121821;        /* panels/cards */
      --muted:#708090;        /* slate */
      --text:#e6edf3;         /* light text */
      --accent:#6aa4ff;       /* accent blue */
      --danger:#ff4d4d;       /* Fap */
      --warn:#ff9f40;         /* Watched */
      --soft:#ffd166;         /* S** */
      --grid:#1b2430;         /* grid lines */
      --today:#1c2a3a;        /* today bg */
      --btn:#1f2937;          /* button bg */
      --btn-hover:#2a3446;    /* button hover */
      --radius:16px;
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background:var(--bg); color:var(--text);
    }

    .container{max-width:1100px; margin:20px auto; padding:0 16px;}

    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; margin-bottom:16px;
    }
    .card{background:var(--panel); border-radius:var(--radius); box-shadow:var(--shadow);}

    .streak{
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      padding:18px 20px;
    }
    .streak-count{font-size:48px; font-weight:800; letter-spacing:1px;}
    .streak-sub{color:var(--muted); font-size:14px}

    .actions{display:flex; gap:10px; flex-wrap:wrap}
    button{background:var(--btn); color:var(--text); border:1px solid #2b3647; padding:10px 14px; border-radius:12px; cursor:pointer}
    button:hover{background:var(--btn-hover)}

    .grid-wrap{margin-top:16px}
    .calendar-header{
      display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid #233044
    }
    .month-title{font-size:20px; font-weight:700}

    .calendar{display:grid; grid-template-columns: repeat(7, 1fr); gap:1px; background:var(--grid); border-radius:0 0 var(--radius) var(--radius); overflow:hidden}
    .dow, .day{background:var(--panel)}
    .dow{padding:10px 6px; text-align:center; font-size:12px; color:var(--muted); font-weight:600}
    .day{
      min-height:100px; padding:8px; position:relative; cursor:pointer;
      border-left: 1px solid #182131; border-top: 1px solid #182131;
    }
    .day-number{font-size:12px; color:var(--muted)}
    .badge{position:absolute; top:8px; right:8px; font-size:11px; padding:3px 8px; border-radius:999px; font-weight:700; border:1px solid rgba(255,255,255,.08)}
    .badge.fap{background: rgba(255,77,77,.1); color: #ffb3b3; border-color: rgba(255,77,77,.25)}
    .badge.watch{background: rgba(255,159,64,.1); color: #ffd7b0; border-color: rgba(255,159,64,.25)}
    .badge.sex{background: rgba(255,209,102,.1); color: #ffe7b3; border-color: rgba(255,209,102,.25)}

    .note{margin-top:8px; font-size:12px; color:#cbd5e1; opacity:.85; line-height:1.3; max-height:3.2em; overflow:hidden}
    .today{background:var(--today)}
    .other-month{opacity:.35}

    .legend{display:flex; gap:10px; align-items:center; flex-wrap:wrap; padding:12px 16px; border-top:1px solid #233044; color:var(--muted); font-size:12px}
    .dot{width:10px; height:10px; border-radius:999px; display:inline-block; margin-right:6px}
    .dot.fap{background:var(--danger)}
    .dot.watch{background:var(--warn)}
    .dot.sex{background:var(--soft)}

    /* Modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; padding:16px; z-index:40 }
    .modal{ width:min(560px, 96vw); background:var(--panel); border-radius:20px; box-shadow:var(--shadow); overflow:hidden }
    .modal header{ padding:14px 16px; border-bottom:1px solid #233044}
    .modal .content{ padding:16px }
    .status-row{ display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap }
    .status-btn{ border-radius:12px; padding:8px 12px; font-weight:700; border:1px solid #2b3647 }
    .status-btn[data-value="Fap"]{ background: rgba(255,77,77,.1); color:#ffb3b3; border-color: rgba(255,77,77,.25) }
    .status-btn[data-value="Watched"]{ background: rgba(255,159,64,.1); color:#ffd7b0; border-color: rgba(255,159,64,.25) }
    .status-btn[data-value="S**"]{ background: rgba(255,209,102,.1); color:#ffe7b3; border-color: rgba(255,209,102,.25) }
    .status-btn.active{ outline:2px solid var(--accent) }
    textarea{ width:100%; min-height:90px; resize:vertical; background:#0f131a; color:var(--text); border:1px solid #2b3647; border-radius:12px; padding:10px }
    .modal footer{ display:flex; justify-content:space-between; gap:10px; padding:14px 16px; border-top:1px solid #233044 }

    /* Panic overlay (white theme) */
    .panic-overlay{ position:fixed; inset:0; background:white; color:#0b0f14; z-index:50; display:none; }
    .panic-inner{ max-width:820px; margin:0 auto; padding:24px 18px 64px }
    .panic-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .panic-title{ font-size:40px; font-weight:900; letter-spacing:.3px }
    .panic-list{ margin-top:14px; font-size:18px; line-height:1.65 }
    .panic-list li{ margin:10px 0; }
    .panic-close{ background:#0b0f14; color:#fff; border:none; padding:10px 14px; border-radius:12px; cursor:pointer }

    /* Responsive tweaks */
    @media (max-width:700px){
      .streak{ flex-direction:column; align-items:flex-start }
      .streak-count{ font-size:38px }
      .day{ min-height:84px }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1 style="margin:6px 0 0 0; font-size:28px">Streak Tracker</h1>
        <div class="streak-sub">Dark mode · Data saved locally · Works offline</div>
      </div>
      <div class="actions">
        <button id="panicBtn" title="Open motivational screen">Panic Button</button>
        <button id="exportBtn" title="Download a backup JSON of your data">Export</button>
        <button id="importBtn" title="Restore from a backup JSON">Import</button>
      </div>
    </header>

    <section class="card streak">
      <div>
        <div class="streak-count" id="streakCount">0</div>
        <div class="streak-sub">days since last break</div>
      </div>
      <div class="actions">
        <button id="breakBtn">Streak Broken</button>
        <button id="editBreakBtn" title="Change the last break date/time">Edit Last Break…</button>
      </div>
    </section>

    <section class="card grid-wrap" aria-label="Calendar">
      <div class="calendar-header">
        <div class="actions">
          <button id="prevMonth" aria-label="Previous month">◀</button>
          <button id="todayBtn">Today</button>
          <button id="nextMonth" aria-label="Next month">▶</button>
        </div>
        <div class="month-title" id="monthTitle">Month YYYY</div>
        <div class="legend">
          <span><span class="dot fap"></span>Fap</span>
          <span><span class="dot watch"></span>Watched</span>
          <span><span class="dot sex"></span>S**</span>
        </div>
      </div>
      <div class="calendar" id="calendar"></div>
    </section>
  </div>

  <!-- Day Modal -->
  <div class="modal-backdrop" id="dayModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="dayModalTitle">
      <header>
        <div id="dayModalTitle" class="month-title">Edit Day</div>
      </header>
      <div class="content">
        <div class="status-row">
          <button class="status-btn" data-value="Fap">Fap</button>
          <button class="status-btn" data-value="Watched">Watched</button>
          <button class="status-btn" data-value="S**">S**</button>
          <button class="status-btn" data-value="" title="Clear status">Clear</button>
        </div>
        <label for="note" style="font-size:12px; color:var(--muted)">Note (optional)</label>
        <textarea id="note" placeholder="Add a short note…"></textarea>
      </div>
      <footer>
        <div class="actions">
          <button id="deleteDayBtn" title="Remove note & status for this day">Delete</button>
        </div>
        <div class="actions">
          <button id="closeModalBtn">Cancel</button>
          <button id="saveDayBtn">Save</button>
        </div>
      </footer>
    </div>
  </div>

  <!-- Panic (White) Overlay -->
  <div class="panic-overlay" id="panic">
    <div class="panic-inner">
      <div class="panic-header">
        <div class="panic-title">Why Not to Do This</div>
        <button class="panic-close" id="panicClose">Close</button>
      </div>
      <ol class="panic-list">
        <li><strong>Addiction</strong></li>
        <li><strong>Fake dopamine</strong> — temporary high, long-term crash</li>
        <li><strong>Need it in time of s**</strong> — dependence hurts real intimacy</li>
        <li><strong>ED</strong> (Erectile Dysfunction) risk</li>
        <li><strong>PE</strong> (Premature Ejaculation) risk</li>
        <li><strong>Go out</strong> — move, sunlight, fresh air</li>
        <li><strong>Call someone</strong> — talk it out, get support</li>
      </ol>
    </div>
  </div>

  <script>
    // ---------- Storage Helpers ----------
    const STORAGE_KEYS = {
      lastBreak: 'streak:lastBreakISO',
      entries: 'calendar:entries' // JSON { yyyy-mm-dd: { status:"Fap|Watched|S**|" , note:"" } }
    };
    const readEntries = () => JSON.parse(localStorage.getItem(STORAGE_KEYS.entries) || '{}');
    const writeEntries = (obj) => localStorage.setItem(STORAGE_KEYS.entries, JSON.stringify(obj));

    function toISODate(d){ return d.toISOString().slice(0,10); }
    function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }

    // ---------- Streak Logic ----------
    const streakEl = document.getElementById('streakCount');

    function getLastBreak(){
      const v = localStorage.getItem(STORAGE_KEYS.lastBreak);
      return v ? new Date(v) : null;
    }
    function setLastBreak(date){
      localStorage.setItem(STORAGE_KEYS.lastBreak, date.toISOString());
      updateStreak();
    }
    function calcStreakDays(){
      const last = getLastBreak();
      if(!last) return 0;
      const now = new Date();
      const diffMs = startOfDay(now) - startOfDay(last);
      const days = Math.floor(diffMs / 86400000);
      // If user just broke the streak today, show 0; after 24h -> 1, etc.
      return Math.max(0, days);
    }
    function updateStreak(){
      streakEl.textContent = calcStreakDays();
    }

    // Update streak every minute in case day rolls over while page is open
    setInterval(updateStreak, 60*1000);

    // Buttons for streak
    document.getElementById('breakBtn').addEventListener('click', ()=>{
      if(confirm('Mark streak as broken now? This resets the counter to 0.')){
        setLastBreak(new Date());
      }
    });
    document.getElementById('editBreakBtn').addEventListener('click', ()=>{
      const last = getLastBreak();
      const def = last ? new Date(last.getTime() - last.getTimezoneOffset()*60000).toISOString().slice(0,16) : '';
      const input = prompt('Enter last break date-time (YYYY-MM-DD HH:MM, 24h). Leave empty to clear.', def.replace('T',' '));
      if(input===null) return;
      if(input.trim()===''){ localStorage.removeItem(STORAGE_KEYS.lastBreak); updateStreak(); return; }
      const normalized = input.replace('T',' ').replace('  ',' ').trim();
      const [d, t] = normalized.split(' ');
      if(!d || !t){ alert('Invalid format.'); return; }
      const [Y,M,D] = d.split('-').map(Number);
      const [h,m] = t.split(':').map(Number);
      const dt = new Date(Y, (M||1)-1, D||1, h||0, m||0, 0);
      if(isNaN(dt)) { alert('Invalid date-time.'); return; }
      setLastBreak(dt);
    });

    // Initialize default lastBreak if missing (so it starts at 0)
    if(!getLastBreak()) setLastBreak(new Date());

    // ---------- Calendar ----------
    const calendarEl = document.getElementById('calendar');
    const monthTitleEl = document.getElementById('monthTitle');
    const todayBtn = document.getElementById('todayBtn');
    let view = startOfDay(new Date()); // current view month

    const DOW = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

    function buildCalendar(year, month){
      calendarEl.innerHTML = '';

      // Header row for days of week
      DOW.forEach(d=>{
        const el = document.createElement('div');
        el.className = 'dow';
        el.textContent = d;
        calendarEl.appendChild(el);
      });

      const first = new Date(year, month, 1);
      const firstDay = first.getDay();
      const daysInMonth = new Date(year, month+1, 0).getDate();

      const prevMonthDays = new Date(year, month, 0).getDate();
      const totalCells = 42; // 6 weeks grid (including DOW row above)

      // Create day cells (including leading/trailing from adjacent months)
      const entries = readEntries();
      const todayISO = toISODate(new Date());

      // Leading cells from prev month
      for(let i=0;i<firstDay;i++){
        const dayNum = prevMonthDays - firstDay + 1 + i;
        const date = new Date(year, month-1, dayNum);
        calendarEl.appendChild(dayCell(date, entries, true, todayISO));
      }
      // Current month
      for(let d=1; d<=daysInMonth; d++){
        const date = new Date(year, month, d);
        calendarEl.appendChild(dayCell(date, entries, false, todayISO));
      }
      // Trailing cells to complete 6x7 grid
      const used = firstDay + daysInMonth;
      const trailing = (7 - (used % 7)) % 7;
      for(let i=1; i<=trailing; i++){
        const date = new Date(year, month+1, i);
        calendarEl.appendChild(dayCell(date, entries, true, todayISO));
      }

      const formatter = new Intl.DateTimeFormat(undefined, { month:'long', year:'numeric' });
      monthTitleEl.textContent = formatter.format(first);
    }

    function dayCell(date, entries, otherMonth, todayISO){
      const cell = document.createElement('div');
      cell.className = 'day' + (otherMonth? ' other-month':'');
      const iso = toISODate(date);
      const isToday = iso === todayISO;
      if(isToday) cell.classList.add('today');

      const num = document.createElement('div');
      num.className = 'day-number';
      num.textContent = date.getDate();

      const noteEl = document.createElement('div');
      noteEl.className = 'note';

      const badge = document.createElement('div');
      badge.className = 'badge';

      const entry = entries[iso];
      if(entry){
        if(entry.status){
          if(entry.status === 'Fap') badge.classList.add('fap');
          else if(entry.status === 'Watched') badge.classList.add('watch');
          else if(entry.status === 'S**') badge.classList.add('sex');
          badge.textContent = entry.status;
        }
        if(entry.note){ noteEl.textContent = entry.note; }
      }

      cell.appendChild(num);
      cell.appendChild(badge);
      cell.appendChild(noteEl);

      cell.addEventListener('click', ()=> openDayModal(date));
      return cell;
    }

    function openDayModal(date){
      const iso = toISODate(date);
      const entries = readEntries();
      const entry = entries[iso] || { status:'', note:'' };

      document.getElementById('dayModalTitle').textContent = new Intl.DateTimeFormat(undefined, {weekday:'long', day:'numeric', month:'long', year:'numeric'}).format(date);
      const modal = document.getElementById('dayModal');
      modal.style.display = 'flex';

      // Status buttons
      const statusBtns = Array.from(modal.querySelectorAll('.status-btn'));
      statusBtns.forEach(btn=>{
        btn.classList.toggle('active', btn.dataset.value === entry.status);
        btn.onclick = () => {
          statusBtns.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          modal.dataset.status = btn.dataset.value || '';
        };
      });
      modal.dataset.status = entry.status || '';

      // Note
      const note = document.getElementById('note');
      note.value = entry.note || '';

      // Save handler
      const saveBtn = document.getElementById('saveDayBtn');
      saveBtn.onclick = () => {
        const newEntry = { status: modal.dataset.status || '', note: note.value.trim() };
        const all = readEntries();
        if(!newEntry.status && !newEntry.note){ delete all[iso]; } else { all[iso] = newEntry; }
        writeEntries(all);
        closeDayModal();
        buildCalendar(view.getFullYear(), view.getMonth());
      };

      // Delete handler
      document.getElementById('deleteDayBtn').onclick = () => {
        const all = readEntries();
        delete all[iso];
        writeEntries(all);
        closeDayModal();
        buildCalendar(view.getFullYear(), view.getMonth());
      };

      // Close handler
      document.getElementById('closeModalBtn').onclick = closeDayModal;

      function closeDayModal(){
        modal.style.display = 'none';
      }
    }

    // Month navigation
    document.getElementById('prevMonth').addEventListener('click', ()=>{
      view = new Date(view.getFullYear(), view.getMonth()-1, 1);
      buildCalendar(view.getFullYear(), view.getMonth());
    });
    document.getElementById('nextMonth').addEventListener('click', ()=>{
      view = new Date(view.getFullYear(), view.getMonth()+1, 1);
      buildCalendar(view.getFullYear(), view.getMonth());
    });
    todayBtn.addEventListener('click', ()=>{
      view = startOfDay(new Date());
      buildCalendar(view.getFullYear(), view.getMonth());
    });

    // Initial render
    updateStreak();
    buildCalendar(view.getFullYear(), view.getMonth());

    // ---------- Panic Overlay ----------
    const panic = document.getElementById('panic');
    document.getElementById('panicBtn').addEventListener('click', ()=>{ panic.style.display='block'; });
    document.getElementById('panicClose').addEventListener('click', ()=>{ panic.style.display='none'; });

    // ---------- Import / Export ----------
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const data = {
        lastBreak: localStorage.getItem(STORAGE_KEYS.lastBreak) || null,
        entries: readEntries()
      };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'streak-tracker-backup.json'; a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('importBtn').addEventListener('click', ()=>{
      const inp = document.createElement('input');
      inp.type='file'; inp.accept='.json,application/json';
      inp.onchange = () => {
        const file = inp.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try{
            const data = JSON.parse(reader.result);
            if(data.lastBreak) localStorage.setItem(STORAGE_KEYS.lastBreak, data.lastBreak);
            if(data.entries && typeof data.entries === 'object') writeEntries(data.entries);
            updateStreak();
            buildCalendar(view.getFullYear(), view.getMonth());
            alert('Import successful.');
          }catch(e){ alert('Invalid JSON.'); }
        };
        reader.readAsText(file);
      };
      inp.click();
    });
  </script>
</body>
</html>
